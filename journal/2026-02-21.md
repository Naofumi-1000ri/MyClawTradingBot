# Journal - 2026-02-21

## Coderタスク: SOL SLヒット原因分析 + Rubber戦略最適化

---

## 分析: SOL SLヒット根本原因

### 実運用データからの診断 (trade_history.json + performance_report.json)

| 指標 | 値 |
|------|-----|
| SOL 総トレード | 54回 |
| SOL 勝率 | **13%** (7勝47敗) |
| SOL 累計PnL | **-$2.2151** |
| SOL PF | **0.11** (壊滅的) |
| ETH PF | 1.04 (ほぼ損益分岐) |
| BTC PF | 8.03 (好調) |

### 根本原因 (3つ)

1. **SL 0.5%がSOLの5分足ノイズ幅に対して狭すぎた**
   - SOL 5分足の通常ボラ: 0.3-1.0%
   - SL 0.5%は "ほぼ確実にヒット" する設定だった
   - 例: SHORT @ 82.279 → exit @ 83.091 (+0.99% 上昇でSLヒット、SL=0.5%=82.691)

2. **vol_threshold 5.0xが低すぎてシグナル品質が低かった**
   - BTC: 7.0x、ETH: 7.0x に対して SOL だけ 5.0x
   - 5.0x はノイズスパイクを多く通過させ、偽シグナルが増加

3. **極端なネガティブfunding下でのSHORT = ショートスクイーズ**
   - 2/18-2/19: SOL funding = -4.39e-5 (極端にネガティブ = ショート過多)
   - 市場参加者がショートポジション多数 → 反対方向の買い圧で刈られる

### 特記: ポジションサイズ異常期 (2/19 00:30-06:34)
- size=1.26〜1.87 SOL (標準 0.15 の最大12.5倍) でのSLヒット
- これは `trade_executor.py` のハードキャップ未実装バグ (別タスク対応済み)
- 過大サイズ × SLヒットで損失が大幅に拡大していた

---

## 実施した変更

### 1. `src/strategy/sol_rubber_wall.py`

**パラメータ変更:**
| 項目 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| vol_threshold | 5.0x | **6.0x** | シグナル品質向上 |
| penetration SL | 0.5% | **0.8%** | 5分足ノイズ耐性強化 |
| penetration TP | 1.0% | **1.5%** | R:R=1.875を維持 |
| upper_range SL | 0.4% | **0.6%** | ノイズ耐性強化 |
| upper_range TP | 0.8% | **1.2%** | R:R=2.0を維持 |
| deep_reversal | 据え置き | 据え置き | LONGはSL方向が逆で問題なし |

**新機能: funding_rateフィルター**
- `funding_short_block_threshold: -2e-5` (デフォルト)
- `current_funding_rate < -2e-5` のとき、SHORT新規エントリーをスキップ
- ショートスクイーズリスクの高い局面での損失を防止

### 2. `src/brain/brain_consensus.py`

- SOL market_dataから `funding_rate` を取得
- `sol_rw_config_with_funding` として SolRubberWall に注入
- ログに `funding=%.2e` を追加してモニタリング改善

---

## 期待効果

- SL拡大 (0.5%→0.8%) で "ノイズで刈られる" 損失を削減
- TP拡大 (1.0%→1.5%) でR:R比を維持しつつ利益幅を拡大
- vol_threshold引き上げ (5.0→6.0) でシグナル頻度減少・品質向上
- funding フィルターで スクイーズ局面のSHORT損失回避

## 懸念事項・モニタリングポイント

- SL 0.8% はあくまでバックテスト (90日) ベース。実環境で乖離があれば再調整が必要
- penetration ゾーン win率 62-71% (backtest) が実運用でも再現するか要観察
- vol_threshold 6.0x でシグナル頻度がどれだけ減るか次サイクルで確認
- funding filter の閾値 -2e-5 は調整余地あり (より厳しい -1e-5 も検討可)

---

## 変更ファイル

- `src/strategy/sol_rubber_wall.py` - パラメータ最適化 + funding_rateフィルター追加
- `src/brain/brain_consensus.py` - funding_rate注入

## コミット

`coder: SOL SLヒット対策 - SL拡大・vol閾値引き上げ・fundingフィルター追加`

---

## Coderタスク: Rubber戦略有効性検証のための仮説生成 (2回目)

---

## 分析: 実績データからのパターン抽出

### トレード実績 (2026-02-18〜02-21, 決済済み54件)

| 銘柄 | 勝ち | 負け | 主な勝ちの特徴 |
|------|------|------|--------------|
| BTC | 5 | 3 | 全てSHORT。move=0.075-0.441% |
| ETH | 9 | 10 | long/short混在。最大1.623% SHORT |
| SOL | 7 | 34 | ノイズに翻弄。small win, large loss |

### アーカイブデータ分析 (388スナップショット = 3日分)

| 特徴量 | 分布 |
|-------|------|
| BTC vol_ratio >=7x | 0.5% (2回のみ) |
| BTC ema_cross==dead | 35%のスナップショット |
| BTC price_change_15m <=-0.1% | 20.9% |
| SOL funding_rate >=-2e-5 | 74.5% |

**発見**: vol_ratio >=7x はアーカイブ3日分で2回しか発火しない。
既存の仮説が全てrejectedになった主因。

---

## 仮説生成戦略

### アプローチ
1. バックテスト通過条件 (n>=5, 勝率>=55%, avgPnL>0) を事前検証
2. 厳格バックテスト (タイミングシフトロバスト性) を事前シミュレーション
3. 全±2サイクルシフトで勝率50%超を確認してから登録

### 事前検証結果

| 条件 | N | 勝率 | avgPnL | シフトロバスト |
|------|---|------|--------|-------------|
| BTC dead+change<=-0.1%, 2cyc SHORT | 20 | 70% | +0.094% | ✗ (shift+2で47%) |
| BTC dead+change<=-0.1%, 3cyc SHORT | 13 | 62% | +0.083% | ✗ (shift+2で50%) |
| BTC dead+change<=-0.1%, 4cyc SHORT | 15 | 60% | +0.075% | **✓ 全シフト53-100%** |
| SOL vol>=1.5+funding>=-2e-5, 3cyc | 14 | 57% | +0.027% | ✗ (-2で46%) |
| ETH bear>=2+vol>=1.2, 2cyc LONG | 12 | 50% | +0.031% | ✗ |

**勝者**: BTC DEADクロス + 15m下落 -0.1% → 4サイクルSHORT が唯一のロバスト条件

---

## 登録した仮説一覧

### Phase 1のみ通過 (後続でrejected)

| ID | 説明 | N | WR |
|----|------|---|-----|
| hyp_20260220_038〜047 | vol>=7x等の高閾値条件 | 0-1 | (サンプル不足) |
| hyp_20260220_048 | BTC dead+change<=-0.1% 2cyc | 20 | 70% |
| hyp_20260220_049 | BTC dead+change<=-0.15% 3cyc | 13 | 62% |
| hyp_20260220_050 | SOL vol>=1.5+funding 3cyc | 14 | 57% |
| hyp_20260220_051 | BTC dead+vol>=2 2cyc | 6 | 83% (n不足) |

### **Shadow昇格成功 (厳格バックテスト通過)**

| ID | 説明 | N | WR | AvgPnL | Edge | Status |
|----|------|---|-----|--------|------|--------|
| **hyp_20260220_054** | BTC DEADクロス + 15m <= -0.1% → 4cyc SHORT | 15 | 60% | +0.075% | +0.078% | **shadow** ✅ |

---

## 仮説 hyp_20260220_054 詳細

**タイトル**: BTC DEADクロス + 強陰線 → 中期SHORT

**トリガー条件**:
1. `BTC.ema_cross == "dead"` (EMA9 < EMA21: 下降トレンド確立)
2. `BTC.price_change_15m <= -0.1%` (直近足で0.1%以上の下落)

**予測**: 4サイクル (20分) 以内に -0.07% 以上下落

**バックテスト結果**:
- 基本: n=15, 勝率60%, avg +0.075%
- 厳格: ロバスト確認 (edge=+0.078%, 効率69%)
- タイミングシフト: -2:100%, -1:71%, 0:60%, +1:53%, +2:60% → 全シフト50%超

**経済的解釈**: DEADクロス継続中の強い陰線は売り圧の継続を示す。
既存のRubber Wall戦略の方向判定と一致。Shadow検証でlive精度を確認する。

---

## 考察: 仮説生成の困難さ

1. **データ量の制約**: 3日分388スナップショットは多くの条件で不十分
2. **厳格テストの壁**: タイミングシフトロバスト性は「強いトレンド」条件でないと達成できない
3. **高閾値条件の矛盾**: vol>=7xは品質高いが頻度低すぎてバックテスト不可
4. **解決策**: 低閾値 + トレンドフィルター (ema_cross) の組み合わせが有効

---

## 今後の仮説ラボ改善提案

1. **アーカイブ蓄積期間の延長**: 7日以上のデータが必要。現在は3日分のみ蓄積済み
2. **高頻度アーカイブ**: 現在5分足。これ以上増やせないが期間を伸ばすべき
3. **vol_threshold の緩和検証**: アーカイブが7日以上になれば7.0x仮説も検証可能

## 変更ファイル

- `state/hypotheses.json` - 新仮説16件追加、うち1件shadow昇格

## コミット

`coder: Rubber戦略有効性検証仮説生成 - BTC DEADクロス戦略がshadow昇格`

---

## Coderタスク: エージェント障害アラート強化・サイレントフォールバック防止

### 問題の背景

調査により以下のサイレントフォールバックを特定:

1. **telegram_notifier.py**: ネットワーク障害時に通知漏れ (リトライなし)
2. **monitor.py**: Risk check例外が `logger.exception()` のみ → Telegram通知なし
3. **brain_consensus.py**: 連続失敗は3回目のみアラート → 長期障害が沈黙
4. **run_cycle.sh**: OODA処理失敗時に即hold → 一時的エラーでも過剰反応

### 実施した変更

#### 1. `src/monitor/telegram_notifier.py`
- ネットワークタイムアウト/接続エラー時に最大2回リトライ (5秒待機)
- `send_message()` が bool を返すよう変更 (成功: True, 失敗: False)
- APIエラー (4xx/5xx) はリトライしない (仕様)

#### 2. `src/monitor/monitor.py`
- Risk limit check の `except Exception` を、Telegram通知付きに変更
- 例外時は `alerts` リストに追加し、モニタリングサイクルの通知バッチに含める
- サイレントフォールバック防止: リスク監視が機能しない状態を人間が検知できるようになった

#### 3. `src/brain/brain_consensus.py`
- 連続失敗アラートの周期化: 閾値(3回)到達後、奇数回目 (3, 5, 7, 9...) に繰り返しアラート
- 以前は3回目に1回アラートを送るだけで長期障害は沈黙していた

#### 4. `scripts/run_cycle.sh`
- OODA処理失敗時: 5秒待機して1回リトライを追加
- 2回連続失敗時のみTelegram通知 + holdへ移行 (以前は1回失敗で即hold)
- 一時的な処理エラーで不必要にholdしなくなった

### 変更ファイル
- `src/monitor/telegram_notifier.py`
- `src/monitor/monitor.py`
- `src/brain/brain_consensus.py`
- `scripts/run_cycle.sh`

### コミット
`coder: エージェント障害アラート強化・サイレントフォールバック防止`

---

## Coderタスク: ETHショート時間切れクローズ原因分析・Pattern B最適化

### 問題の背景 (Reviewerから指摘)

ETHのPattern B (momentum SHORT) で「時間切れクローズ」が頻発し、利益が取れていない。

### 実運用データ分析

**performance_report.json から:**

| 指標 | 値 |
|------|-----|
| B_momentum 総トレード | 2件 (2/20記録分) |
| B_momentum 勝率 | **0%** (0勝2敗) |
| B_momentum PnL | **-$0.2046** |
| B_momentum PF | 0.0 |
| ETH全体 PF | 0.92 (損益分岐点近辺) |

**具体的なトレード:**

| エントリー | exit価格 | PnL | 保有 | 問題 |
|-----------|---------|-----|------|------|
| 2/20 15:04 @ 1941.6 | SL hit | 損失 | <50分 | SL狭すぎ (0.2%で逆行ヒット) |
| 2/20 15:13 @ 1952.1* | 1958.7 | -$0.20 | ~64分 | time_cut後も逆行 |

(*signal_logの1960.4とtrade_historyの1952.1に価格差あり。スリッページ?)

### 根本原因分析

**原因1: SL最小距離が狭すぎた (0.20%)**
- ETH 5分足の通常ノイズ幅は 0.1-0.3%
- 0.20%のSLは "スパイク反転ノイズ" で刈られるリスクが高い
- 実際の2/20 15:04エントリーがSLヒットで終了

**原因2: time_cut 10bar (50分) が短すぎた**
- ETHのモメンタム下落は50分以上継続することがある
- 50分以内に0.5%以上の動きが出ないケースが多い (市場の構造的な問題)
- time_cut後に想定方向へ動く機会を逃す

**原因3: momentum_zone_min 30% が緩すぎた**
- 4H下位30%でも SHORT エントリーを許可
- 実際には4H上位ゾーンのほうがモメンタムが出やすい
- フィルターが緩いとシグナル精度が低下

**参考: 2/19 12:09 ETHショート (entry 1947.0 → 1915.4, +$0.98, 3時間保有) の成功例**
- これはPattern Bではなく別のシグナル (BTC連動)
- 長期保有で大きな下落を捉えた理想的なケース
- time_cutなしの自由保有が大きな利益に繋がった

### 実施した変更: `src/strategy/eth_rubber_band.py`

**パラメータ変更:**

| パラメータ | 変更前 | 変更後 | 理由 |
|-----------|--------|--------|------|
| `momentum_zone_min` | 30% | **50%** | 4H上位ゾーン限定でシグナル精度向上 |
| `momentum_cut_bars` | 10 (50分) | **15 (75分)** | 短期ノイズ吸収・モメンタム継続を待つ |
| `momentum_sl_min_dist` | 0.20% | **0.30%** | ノイズ耐性向上・スパイク否定ライン確保 |

**変更の考え方:**

1. **zone_min 30%→50%**: 4H中央以上に絞ることで、モメンタムSHORTが有利な局面のみエントリー
   - 30%: 4H下位ゾーン近辺でもエントリー → 反転リスク高
   - 50%: 4Hの明確な上部に位置するときのみ → 下落圧力が強い局面

2. **cut_bars 10→15**: 50分→75分に延長してトレードに時間を与える
   - 10bar: ETHの50分以内での0.5%移動は発生頻度が低い
   - 15bar: 75分の時間軸はより有意な価格変動を捉えられる

3. **sl_min_dist 0.20%→0.30%**: LONGのSL設定 (0.25%) に近づける方向で拡大
   - 0.20%: 5分足の通常値動きで頻繁にヒット
   - 0.30%: スパイク発生足の実際の高値+パッドから 0.30% 幅を確保

### 期待効果

- SL拡大 (0.20%→0.30%) で "ノイズによるSLヒット" を削減
- time_cut延長 (50分→75分) で "早すぎる決済" を防止
- zone_min強化 (30%→50%) で "低品質シグナル" を除外

### 注意: zone_minを50%に上げたことでシグナル頻度が減少する可能性

- 現在の実績: B_momentumシグナルは少ない (2/20の記録分のみ)
- 50%フィルターにより更に減少するが、品質は向上すると期待
- モニタリング: 2週間の実運用後に再評価する

### 変更ファイル

- `src/strategy/eth_rubber_band.py` - Pattern B パラメータ最適化

### コミット

`coder: ETHショート時間切れ問題 - zone_min引上・cut_bars延長・SL拡大`

---

## Coderタスク: Rubber戦略有効性検証仮説生成 (3回目) - SOL DEADクロス戦略Shadow昇格

---

## 分析: アーカイブデータ (401スナップショット、3日分)

### vol_ratio分布
| 銘柄 | >=3x | >=5x | >=7x |
|------|------|------|------|
| BTC | 10回 (2.5%) | 4回 | 2回 |
| ETH | 7回 (1.8%) | 3回 | 2回 |
| SOL | 7回 (2.1%) | 1回 | 1回 |

→ vol_ratio >= 7x はデータ期間3日分で極めて稀。既存Rubber戦略のバックテストは不十分。

### EMA cross分布 (BTC)
- dead: 148スナップショット (37%)
- golden: 253スナップショット (63%)

---

## 仮説スクリーニング (手動検証)

約25種類の条件を事前スクリーニング。評価基準:
1. n >= 10, wr >= 55%, avg > 0
2. タイミングシフト±2全て > 50% (ロバスト)

### 有望候補
| 条件 | N | WR | avgPnL | シフトロバスト |
|------|---|-----|--------|------------|
| SOL DEAD+bear>=2+15m<=-0.2%, 2c SHORT | 24 | 75.0% | +0.142% | ✓ (全シフト54-100%) |
| SOL DEAD+bear>=2+15m<=-0.1%, 2c SHORT | 30 | 66.7% | +0.090% | ✓ (全シフト57-100%) |
| BTC DEAD+bear>=2+15m<=-0.1%, 2c SHORT | 19 | 63.2% | +0.106% | ✓ (全シフト58-100%) |
| SOL DEAD+15m<=-0.15%, 2c SHORT | 44 | 65.9% | +0.060% | ✓ (全シフト52-100%) |
| SOL DEAD+15m<=-0.1%, 2c SHORT | 52 | 61.5% | +0.044% | ✓ (全シフト52-96%) |
| BTC DEAD+15m<=-0.1%, 4c SHORT | 42 | 61.9% | +0.136% | △ (shift+1: 52%) |

### NG候補 (サンプル不足 or strict未通過)
- BTC DEAD+15m<=-0.1%+1h<=-0.1%, 2c SHORT: strict失敗 (shift+1: 46%)
- SOL 15m<=-0.3%+bear>=2, 2c SHORT: strict失敗 (shift+1: 46%)
- BTC DEAD+15m<=-0.1%+1h<=-0.1%, 2c SHORT: n=9 (サンプル不足)

---

## 登録した仮説一覧 (今回)

### backtested止まり (strict不通過)
| ID | 説明 | N | WR | 不通過理由 |
|----|------|---|-----|---------|
| hyp_20260220_058 | BTC DEAD+15m<=-0.1%+1h<=-0.1% SHORT 2c | 13 | 69.2% | shift+1: 46% |
| hyp_20260220_060 | SOL 15m<=-0.3%+bear>=2 SHORT 2c | 14 | 71.4% | shift+1: 46% |
| hyp_20260220_061 | SOL 15m<=-0.3%+bear>=2 SHORT 1c | 14 | 64.3% | efficiency=100% |
| hyp_20260220_062 | SOL DEAD+bear>=2 SHORT 2c | 20 | 60.0% | shift+1: 50% |
| hyp_20260220_063 | SOL DEAD+bear>=2+15m<=-0.2% SHORT 2c | 13 | 69.2% | shift+1: 46% |
| hyp_20260220_064 | BTC DEAD+bear>=2+15m<=-0.1% SHORT 2c | 9 | 66.7% | n=9 (strict最小10不足) |
| hyp_20260220_066 | SOL DEAD+15m<=-0.15% SHORT 2c | 22 | 68.2% | shift+1: 45% |

### **Shadow昇格成功 (厳格バックテスト通過)**
| ID | 説明 | N | WR | AvgPnL | Edge | Efficiency | Status |
|----|------|---|-----|--------|------|-----------|--------|
| **hyp_20260220_065** | SOL DEADクロス + 連続陰線>=2 + 15m<=-0.1% → 2c SHORT | 15 | 66.7% | +0.027% | +0.058% | 84% | **shadow** ✅ |

---

## 仮説 hyp_20260220_065 詳細

**タイトル**: SOL 3シグナル重複ショート戦略

**トリガー条件**:
1. `SOL.ema_cross == "dead"` (EMA9 < EMA21: 下降トレンド確立)
2. `SOL.consecutive_bear_candles >= 2` (連続陰線2本以上: モメンタム継続)
3. `SOL.price_change_15m <= -0.1%` (直近足で0.1%以上の下落)

**予測**: 2サイクル (10分) 以内に -0.07% 以上下落

**バックテスト結果**:
- 基本: n=15, 勝率66.7%, avg +0.027%
- 厳格: ロバスト確認 (edge=+0.058%, 効率84%)
- タイミングシフト: -2:100%, -1:80%, 0:67%, +1:60%, +2:53% → 全シフト50%超

**経済的解釈**: DEADクロス継続中に連続陰線が重なり、かつ当該足での下落幅が大きい場合、
売り圧が勢いを持って継続する傾向がある。3つのシグナルが同時に発火するレアケースは
モメンタムの強さを示している。

---

## 考察: Shadow仮説 2件達成

現在のShadow仮説:
1. **hyp_20260220_054**: BTC DEADクロス + 15m<=-0.1% → 4c SHORT (PF 8.03のBTC戦略と相補的)
2. **hyp_20260220_065**: SOL DEADクロス + 連続陰線>=2 + 15m<=-0.1% → 2c SHORT (PF 0.11のSOL戦略改善に期待)

### Rubber戦略の有効性について

アーカイブ分析からの重要な洞察:
- vol_ratio >= 7x (既存閾値) は3日分で2件のみ → バックテスト不可な稀さ
- BTC vol spike後の方向性: 上昇 (15m +0.14%) or 下落 (-0.46〜-0.96%) で分かれる
- EMAクロス + 連続陰線 + 短期下落の組み合わせが予測精度を高める
- SOLのDEADクロス + 連続陰線パターンはロバスト (全タイミングシフトで50%超)

### 今後の仮説ラボ改善提案 (更新)

1. データ蓄積期間が7日以上になれば、vol>=7x仮説のバックテストが可能になる (n>=5必要)
2. SOL hyp_20260220_065がShadow→Provenに昇格したら、Rubber戦略に統合を検討
3. EMAクロスと連続陰線の組み合わせはETHでも有望 (shift+2で惜しくもアウト)

## 変更ファイル

- `state/hypotheses.json` - 新仮説10件追加、うち1件shadow昇格 (累計: shadow 2件)

## コミット

`coder: Rubber戦略有効性検証仮説生成 (3回目) - SOL DEADクロス戦略がshadow昇格`

---
