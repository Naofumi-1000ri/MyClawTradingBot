# Journal - 2026-02-21

## Coderタスク: SOL SLヒット原因分析 + Rubber戦略最適化

---

## 分析: SOL SLヒット根本原因

### 実運用データからの診断 (trade_history.json + performance_report.json)

| 指標 | 値 |
|------|-----|
| SOL 総トレード | 54回 |
| SOL 勝率 | **13%** (7勝47敗) |
| SOL 累計PnL | **-$2.2151** |
| SOL PF | **0.11** (壊滅的) |
| ETH PF | 1.04 (ほぼ損益分岐) |
| BTC PF | 8.03 (好調) |

### 根本原因 (3つ)

1. **SL 0.5%がSOLの5分足ノイズ幅に対して狭すぎた**
   - SOL 5分足の通常ボラ: 0.3-1.0%
   - SL 0.5%は "ほぼ確実にヒット" する設定だった
   - 例: SHORT @ 82.279 → exit @ 83.091 (+0.99% 上昇でSLヒット、SL=0.5%=82.691)

2. **vol_threshold 5.0xが低すぎてシグナル品質が低かった**
   - BTC: 7.0x、ETH: 7.0x に対して SOL だけ 5.0x
   - 5.0x はノイズスパイクを多く通過させ、偽シグナルが増加

3. **極端なネガティブfunding下でのSHORT = ショートスクイーズ**
   - 2/18-2/19: SOL funding = -4.39e-5 (極端にネガティブ = ショート過多)
   - 市場参加者がショートポジション多数 → 反対方向の買い圧で刈られる

### 特記: ポジションサイズ異常期 (2/19 00:30-06:34)
- size=1.26〜1.87 SOL (標準 0.15 の最大12.5倍) でのSLヒット
- これは `trade_executor.py` のハードキャップ未実装バグ (別タスク対応済み)
- 過大サイズ × SLヒットで損失が大幅に拡大していた

---

## 実施した変更

### 1. `src/strategy/sol_rubber_wall.py`

**パラメータ変更:**
| 項目 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| vol_threshold | 5.0x | **6.0x** | シグナル品質向上 |
| penetration SL | 0.5% | **0.8%** | 5分足ノイズ耐性強化 |
| penetration TP | 1.0% | **1.5%** | R:R=1.875を維持 |
| upper_range SL | 0.4% | **0.6%** | ノイズ耐性強化 |
| upper_range TP | 0.8% | **1.2%** | R:R=2.0を維持 |
| deep_reversal | 据え置き | 据え置き | LONGはSL方向が逆で問題なし |

**新機能: funding_rateフィルター**
- `funding_short_block_threshold: -2e-5` (デフォルト)
- `current_funding_rate < -2e-5` のとき、SHORT新規エントリーをスキップ
- ショートスクイーズリスクの高い局面での損失を防止

### 2. `src/brain/brain_consensus.py`

- SOL market_dataから `funding_rate` を取得
- `sol_rw_config_with_funding` として SolRubberWall に注入
- ログに `funding=%.2e` を追加してモニタリング改善

---

## 期待効果

- SL拡大 (0.5%→0.8%) で "ノイズで刈られる" 損失を削減
- TP拡大 (1.0%→1.5%) でR:R比を維持しつつ利益幅を拡大
- vol_threshold引き上げ (5.0→6.0) でシグナル頻度減少・品質向上
- funding フィルターで スクイーズ局面のSHORT損失回避

## 懸念事項・モニタリングポイント

- SL 0.8% はあくまでバックテスト (90日) ベース。実環境で乖離があれば再調整が必要
- penetration ゾーン win率 62-71% (backtest) が実運用でも再現するか要観察
- vol_threshold 6.0x でシグナル頻度がどれだけ減るか次サイクルで確認
- funding filter の閾値 -2e-5 は調整余地あり (より厳しい -1e-5 も検討可)

---

## 変更ファイル

- `src/strategy/sol_rubber_wall.py` - パラメータ最適化 + funding_rateフィルター追加
- `src/brain/brain_consensus.py` - funding_rate注入

## コミット

`coder: SOL SLヒット対策 - SL拡大・vol閾値引き上げ・fundingフィルター追加`
