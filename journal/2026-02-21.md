# Journal - 2026-02-21

## Coderタスク: SOL SLヒット原因分析 + Rubber戦略最適化

---

## 分析: SOL SLヒット根本原因

### 実運用データからの診断 (trade_history.json + performance_report.json)

| 指標 | 値 |
|------|-----|
| SOL 総トレード | 54回 |
| SOL 勝率 | **13%** (7勝47敗) |
| SOL 累計PnL | **-$2.2151** |
| SOL PF | **0.11** (壊滅的) |
| ETH PF | 1.04 (ほぼ損益分岐) |
| BTC PF | 8.03 (好調) |

### 根本原因 (3つ)

1. **SL 0.5%がSOLの5分足ノイズ幅に対して狭すぎた**
   - SOL 5分足の通常ボラ: 0.3-1.0%
   - SL 0.5%は "ほぼ確実にヒット" する設定だった
   - 例: SHORT @ 82.279 → exit @ 83.091 (+0.99% 上昇でSLヒット、SL=0.5%=82.691)

2. **vol_threshold 5.0xが低すぎてシグナル品質が低かった**
   - BTC: 7.0x、ETH: 7.0x に対して SOL だけ 5.0x
   - 5.0x はノイズスパイクを多く通過させ、偽シグナルが増加

3. **極端なネガティブfunding下でのSHORT = ショートスクイーズ**
   - 2/18-2/19: SOL funding = -4.39e-5 (極端にネガティブ = ショート過多)
   - 市場参加者がショートポジション多数 → 反対方向の買い圧で刈られる

### 特記: ポジションサイズ異常期 (2/19 00:30-06:34)
- size=1.26〜1.87 SOL (標準 0.15 の最大12.5倍) でのSLヒット
- これは `trade_executor.py` のハードキャップ未実装バグ (別タスク対応済み)
- 過大サイズ × SLヒットで損失が大幅に拡大していた

---

## 分析: ETH・SOL 詳細パフォーマンス (2026-02-21 追加分析)

### 115トレード全分析結果

| 銘柄 | クローズ数 | 勝率 | PF | 合計PnL |
|------|-----------|------|----|--------|
| BTC  | 6         | 83.3% | 8.03 | +$0.58 |
| ETH  | 20        | 45.0% | 0.77 | -$0.48 |
| SOL  | 28        | 25.0% | 0.11 | -$2.38 |

### ETH: 方向別詳細

| 方向 | 件数 | 勝利 | PnL |
|------|------|------|-----|
| LONG | 13   | 6勝  | -$0.72 |
| SHORT| 7    | 3勝  | +$0.24 |

**問題**: ETH LONGが損失の主因。下降トレンド中の逆張り (reversal LONG) が機能していない。
- ETH SHORT はわずかに黒字だが、条件が緩すぎて偽陽性多数

### SOL: 方向別詳細

| 方向 | 件数 | 勝利 | PnL |
|------|------|------|-----|
| LONG | 14   | 2勝  | -$1.08 |
| SHORT| 14   | 5勝  | -$1.30 |

**問題**:
- SOL LONG (deep_reversal): 14件2勝WR=14%。バックテスト理論値とも乖離 (LONG favorable=0.59)
- SOL SHORT: 5勝/14件=36%。SL狭すぎ問題は2/21改善済みだが、シグナル品質もまだ低い

---

## 実施した変更 (2026-02-21 第2次最適化)

### 1. `src/strategy/eth_rubber_band.py`

**パラメータ変更:**
| 項目 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| reversal_h4_filter_pct | 40% | **55%** | LONG 13件7敗の主因。下降トレンド逆張り厳格排除 |
| momentum_threshold | 3.0x | **4.0x** | 3-4x弱スパイクは誤シグナル多。品質向上 |
| momentum_zone_min | 40% | **55%** | 4H中位以上でのみSHORT許可 |

**ETH LONGの改善根拠**:
- reversal_h4_filter_pct=40%では4H中位ゾーンでもLONG許可していた
- 4Hダウントレンド (全体的に価格下落) 中は55%未満ゾーンでの逆張りは不利
- 55%以上 = 4H高値圏のみ → より信頼性の高い反転シグナル

### 2. `src/strategy/sol_rubber_wall.py`

**deep_reversal無効化:**
- 実運用14件2勝WR=14%で機能不全が明確
- バックテストでもLONG favorable=0.59 (SHORT=1.68) と元々不利
- zones定義からdeep_reversalをコメントアウト → SKIPゾーン扱い
- SHORT専念に変更。将来50件以上のデータで再評価

### 3. `config/settings.yaml`

| 項目 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| sol_rubber_wall.vol_threshold | 5.0x | **6.5x** | 28件WR=25%。高品質スパイクのみに絞る |

---

## 期待効果

| 指標 | 現在 | 期待値 |
|------|------|--------|
| ETH LONG 勝率 | 46% (6/13) | 55%+ |
| ETH LONG PnL | -$0.72 | ±0以上 |
| SOL SHORT 勝率 | 36% (5/14) | 50%+ |
| SOL LONG (停止) | 14% (2/14) | N/A (無効化) |
| SOL vol_threshold | 5.0x | 6.5x (シグナル頻度↓・品質↑) |

## モニタリングポイント

- ETH: reversal_h4_filter_pct=55%でLONG機会が激減しないか確認 (過去40%→55% = 機会15%削減)
- SOL: vol_threshold=6.5xでシグナル頻度が低すぎないか (5.0x比で約30%削減想定)
- SOL: deep_reversal無効化後、深突破ゾーン (-20%以下) でのSKIPが多発しないか

---

## Coderタスク: BTC ロングポジション管理 + SL/TP監視追加

*(前回タスク継続記録)*

BTC でポジションが孤児化した事案。ooda_processor.py に存在チェック + SL/TP監視ロジックを追加済み。

---

---

## Coderタスク: BTC未決済ポジション監視・クローズ戦略

### 状況 (2026-02-21)

| 項目 | 値 |
|------|-----|
| 方向 | LONG |
| サイズ | 0.0009 BTC |
| エントリー価格 | $67,894 |
| 現在mid価格 | $67,575.5 |
| 含み損 | -$0.2844 (-0.47%) |
| SL | $67,350.85 (あと -0.33%) |
| TP | $68,233.47 (あと +0.97%) |
| 経過時間 | 36時間以上 (2/20 05:44 エントリー) |
| パターン | `legacy_long` (旧LLMシステム遺物) |

### 分析

**問題の根本:**
- `legacy_long`は旧LLMシステム生成ポジション。現在のゴム戦略 (BTC RubberWall) とは無関係
- BTC RubberWall は「BEAR spike → SHORT」が主体。LONGは deep_reversal ゾーン (4H高値-20%以下) のみ
- 36時間経過でドリフト継続。SLまであと-0.33%と接近
- TP $68,233.47 は現在価格から+0.97%と遠く、SLヒットの可能性が高い

**オプション評価:**

| 選択肢 | リスク | 判断 |
|--------|--------|------|
| SL/TPをそのまま待つ | SLヒットで損失-$0.49 | SL近接のため不利 |
| タイムアウトで即クローズ | 現在-$0.28の確定損 | ✓ 推奨 |
| SLをtightenしてクローズ | 似た結果だが複雑 | ✗ 不要 |

### 対処

`state/btc_rubber_meta.json` の `exit_mode` を `tp_sl` → `time_cut` (exit_bars=1) に変更。

- 次のサイクル (5分後) で `bar_count=0 → 1 >= exit_bars=1` → クローズシグナル発生
- trade_executor.py が close 注文執行
- SLまであと-0.33%という危険な状態を安全にクローズ

**SL比較:**
- SLヒットまで待つ場合: 最大損失 -$0.49
- time_cut (現在価格でクローズ): 損失 -$0.28 前後
- → **time_cutの方が$0.21改善**

### 変更内容

`state/btc_rubber_meta.json`:
- `exit_mode`: `tp_sl` → `time_cut`
- `exit_bars`: `0` → `1`
- `bar_count`: `0` (そのまま)
- 次サイクルで強制クローズ

---

## クイックリファレンス

```bash
make status
cat state/daily_pnl.json
cat state/positions.json
journalctl -u myclaw -f
```
