# Journal - 2026-02-21

## Coderタスク: SOL SLヒット原因分析 + Rubber戦略最適化

---

## 分析: SOL SLヒット根本原因

### 実運用データからの診断 (trade_history.json + performance_report.json)

| 指標 | 値 |
|------|-----|
| SOL 総トレード | 54回 |
| SOL 勝率 | **13%** (7勝47敗) |
| SOL 累計PnL | **-$2.2151** |
| SOL PF | **0.11** (壊滅的) |
| ETH PF | 1.04 (ほぼ損益分岐) |
| BTC PF | 8.03 (好調) |

### 根本原因 (3つ)

1. **SL 0.5%がSOLの5分足ノイズ幅に対して狭すぎた**
   - SOL 5分足の通常ボラ: 0.3-1.0%
   - SL 0.5%は "ほぼ確実にヒット" する設定だった
   - 例: SHORT @ 82.279 → exit @ 83.091 (+0.99% 上昇でSLヒット、SL=0.5%=82.691)

2. **vol_threshold 5.0xが低すぎてシグナル品質が低かった**
   - BTC: 7.0x、ETH: 7.0x に対して SOL だけ 5.0x
   - 5.0x はノイズスパイクを多く通過させ、偽シグナルが増加

3. **極端なネガティブfunding下でのSHORT = ショートスクイーズ**
   - 2/18-2/19: SOL funding = -4.39e-5 (極端にネガティブ = ショート過多)
   - 市場参加者がショートポジション多数 → 反対方向の買い圧で刈られる

### 特記: ポジションサイズ異常期 (2/19 00:30-06:34)
- size=1.26〜1.87 SOL (標準 0.15 の最大12.5倍) でのSLヒット
- これは `trade_executor.py` のハードキャップ未実装バグ (別タスク対応済み)
- 過大サイズ × SLヒットで損失が大幅に拡大していた

---

## 分析: ETH・SOL 詳細パフォーマンス (2026-02-21 追加分析)

### 115トレード全分析結果

| 銘柄 | クローズ数 | 勝率 | PF | 合計PnL |
|------|-----------|------|----|--------|
| BTC  | 6         | 83.3% | 8.03 | +$0.58 |
| ETH  | 20        | 45.0% | 0.77 | -$0.48 |
| SOL  | 28        | 25.0% | 0.11 | -$2.38 |

### ETH: 方向別詳細

| 方向 | 件数 | 勝利 | PnL |
|------|------|------|-----|
| LONG | 13   | 6勝  | -$0.72 |
| SHORT| 7    | 3勝  | +$0.24 |

**問題**: ETH LONGが損失の主因。下降トレンド中の逆張り (reversal LONG) が機能していない。
- ETH SHORT はわずかに黒字だが、条件が緩すぎて偽陽性多数

### SOL: 方向別詳細

| 方向 | 件数 | 勝利 | PnL |
|------|------|------|-----|
| LONG | 14   | 2勝  | -$1.08 |
| SHORT| 14   | 5勝  | -$1.30 |

**問題**:
- SOL LONG (deep_reversal): 14件2勝WR=14%。バックテスト理論値とも乖離 (LONG favorable=0.59)
- SOL SHORT: 5勝/14件=36%。SL狭すぎ問題は2/21改善済みだが、シグナル品質もまだ低い

---

## 実施した変更 (2026-02-21 第2次最適化)

### 1. `src/strategy/eth_rubber_band.py`

**パラメータ変更:**
| 項目 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| reversal_h4_filter_pct | 40% | **55%** | LONG 13件7敗の主因。下降トレンド逆張り厳格排除 |
| momentum_threshold | 3.0x | **4.0x** | 3-4x弱スパイクは誤シグナル多。品質向上 |
| momentum_zone_min | 40% | **55%** | 4H中位以上でのみSHORT許可 |

**ETH LONGの改善根拠**:
- reversal_h4_filter_pct=40%では4H中位ゾーンでもLONG許可していた
- 4Hダウントレンド (全体的に価格下落) 中は55%未満ゾーンでの逆張りは不利
- 55%以上 = 4H高値圏のみ → より信頼性の高い反転シグナル

### 2. `src/strategy/sol_rubber_wall.py`

**deep_reversal無効化:**
- 実運用14件2勝WR=14%で機能不全が明確
- バックテストでもLONG favorable=0.59 (SHORT=1.68) と元々不利
- zones定義からdeep_reversalをコメントアウト → SKIPゾーン扱い
- SHORT専念に変更。将来50件以上のデータで再評価

### 3. `config/settings.yaml`

| 項目 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| sol_rubber_wall.vol_threshold | 5.0x | **6.5x** | 28件WR=25%。高品質スパイクのみに絞る |

---

## 期待効果

| 指標 | 現在 | 期待値 |
|------|------|--------|
| ETH LONG 勝率 | 46% (6/13) | 55%+ |
| ETH LONG PnL | -$0.72 | ±0以上 |
| SOL SHORT 勝率 | 36% (5/14) | 50%+ |
| SOL LONG (停止) | 14% (2/14) | N/A (無効化) |
| SOL vol_threshold | 5.0x | 6.5x (シグナル頻度↓・品質↑) |

## モニタリングポイント

- ETH: reversal_h4_filter_pct=55%でLONG機会が激減しないか確認 (過去40%→55% = 機会15%削減)
- SOL: vol_threshold=6.5xでシグナル頻度が低すぎないか (5.0x比で約30%削減想定)
- SOL: deep_reversal無効化後、深突破ゾーン (-20%以下) でのSKIPが多発しないか

---

## Coderタスク: BTC ロングポジション管理 + SL/TP監視追加

*(前回タスク継続記録)*

BTC でポジションが孤児化した事案。ooda_processor.py に存在チェック + SL/TP監視ロジックを追加済み。

---

---

## Coderタスク: BTC未決済ポジション監視・クローズ戦略

### 状況 (2026-02-21)

| 項目 | 値 |
|------|-----|
| 方向 | LONG |
| サイズ | 0.0009 BTC |
| エントリー価格 | $67,894 |
| 現在mid価格 | $67,575.5 |
| 含み損 | -$0.2844 (-0.47%) |
| SL | $67,350.85 (あと -0.33%) |
| TP | $68,233.47 (あと +0.97%) |
| 経過時間 | 36時間以上 (2/20 05:44 エントリー) |
| パターン | `legacy_long` (旧LLMシステム遺物) |

### 分析

**問題の根本:**
- `legacy_long`は旧LLMシステム生成ポジション。現在のゴム戦略 (BTC RubberWall) とは無関係
- BTC RubberWall は「BEAR spike → SHORT」が主体。LONGは deep_reversal ゾーン (4H高値-20%以下) のみ
- 36時間経過でドリフト継続。SLまであと-0.33%と接近
- TP $68,233.47 は現在価格から+0.97%と遠く、SLヒットの可能性が高い

**オプション評価:**

| 選択肢 | リスク | 判断 |
|--------|--------|------|
| SL/TPをそのまま待つ | SLヒットで損失-$0.49 | SL近接のため不利 |
| タイムアウトで即クローズ | 現在-$0.28の確定損 | ✓ 推奨 |
| SLをtightenしてクローズ | 似た結果だが複雑 | ✗ 不要 |

### 対処

`state/btc_rubber_meta.json` の `exit_mode` を `tp_sl` → `time_cut` (exit_bars=1) に変更。

- 次のサイクル (5分後) で `bar_count=0 → 1 >= exit_bars=1` → クローズシグナル発生
- trade_executor.py が close 注文執行
- SLまであと-0.33%という危険な状態を安全にクローズ

**SL比較:**
- SLヒットまで待つ場合: 最大損失 -$0.49
- time_cut (現在価格でクローズ): 損失 -$0.28 前後
- → **time_cutの方が$0.21改善**

### 変更内容

`state/btc_rubber_meta.json`:
- `exit_mode`: `tp_sl` → `time_cut`
- `exit_bars`: `0` → `1`
- `bar_count`: `0` (そのまま)
- 次サイクルで強制クローズ

---

## クイックリファレンス

```bash
make status
cat state/daily_pnl.json
cat state/positions.json
journalctl -u myclaw -f
```

---

## Coderタスク: 市場パターン分析 + 新規仮説14件生成

### 背景・動機

Reviewerレポート (state/review.json) による優先課題:
- 直近12サイクルで90%以上が「Rubber fallback: スパイクなし: 静観」
- performance_score: 40/100
- [CRITICAL] フォールバック状態が壊滅的 → トレード機会損失

**根本原因の特定**:
- 425スナップショット (2026-02-18〜20) を分析
- BTC 5x+ BEAR spike: **わずか1件/425 (0.2%)**
- ETH 7x+ BEAR spike: **0件/425**
- SOL 6.5x+ BEAR spike: **0件/425**
- 結論: 現在のゴム戦略は **99.8%以上の時間を静観**

---

### 分析データ (425スナップショット)

#### 有効パターンの発見

| パターン | サンプル | WR/発生率 |
|---------|---------|----------|
| BTC bull spike 2x+ + BULL candle | 15件 | WR_long=**40%** |
| ETH ask_max急増(2倍以上) -> 3cyc後 | 58件 | drop(-0.2%): 24% |
| BTC 連続陰線3本+ -> 継続 | 31件 | WR=23% |
| SOL imbalance<0.5 (ask優勢) -> short | 124件 | WR=29% |
| BTC funding >5e-6 -> drop | 367件 | WR=26% |
| ETH negative funding -> drop | 44件 | WR=25% |
| BTC extreme bid dominant (imbalance>500) | 33件 | WR_up=36% |

#### 15m出来高分布 (vol_ratio パーセンタイル)

| 銘柄 | p50 | p75 | p90 | p95 | p99 |
|-----|-----|-----|-----|-----|-----|
| BTC | 0.3x | 0.7x | 1.5x | 2.2x | 4.8x |
| ETH | 0.2x | 0.6x | 1.4x | 2.2x | 3.1x |
| SOL | 0.3x | 0.8x | 1.7x | 2.1x | 4.0x |

**注**: 現在のthreshold (BTC:5x, ETH:3-7x, SOL:6.5x) は p99 相当。希少すぎる。

---

### 生成した新規仮説 (14件)

IDs: `hyp_20260220_096` 〜 `hyp_20260220_109`

| ID | カテゴリ | 銘柄 | 方向 | 根拠 |
|----|---------|------|------|------|
| _096 | トレンドフォロー | BTC | short | dead+連続陰線3本+funding>3e-6 |
| _097 | トレンドフォロー | ETH | short | ask壁500++dead+4H下降 |
| _098 | トレンドフォロー | BTC | long | bull spike 2x++golden (WR実証40%) |
| _099 | SOL固有 | SOL | short | dead+imbalance<0.5+funding neutral |
| _100 | SOL固有 | SOL | short | 連続陰線3本+4H下降 |
| _101 | クロス銘柄 | ETH | short | BTC+ETH両方dead同期 |
| _102 | クロス銘柄 | SOL | short | BTC funding高+SOL dead |
| _103 | MACD | BTC | short | dead+MACD expanding |
| _104 | MACD | ETH | short | dead+MACD expanding+4H下降 |
| _105 | Orderbook | BTC | long | bid厚(>20)+ask薄(<=2)+golden |
| _106 | Orderbook | SOL | long | bid_max>=200+imbalance>2+neutral+golden (deep_reversal代替) |
| _107 | 感度検証 | BTC | short | vol 3.5-5x BEAR+dead (threshold引き下げ検証) |
| _108 | 感度検証 | ETH | short | vol 2.5-3.0x BEAR+dead+neg_funding |
| _109 | FFT実験 | ETH | short | spectral_entropy<0.80+dead+1H下落 |

### 仮説データベース状態

| ステータス | 件数 | 変化 |
|----------|------|------|
| raw | 20 | **+14** (今回生成) |
| shadow | 7 | 変化なし |
| rejected | 127 | 変化なし |
| 合計 | 154 | +14 |

### 次のアクション

1. **backtester.py でバックテスト実行** (run_reviewer.sh経由で自動)
2. **shadow昇格後の監視**: trigger条件が実際に発火するか追跡
3. **重点監視**: hyp_096 (BTC連続陰線)、hyp_098 (BTC bull LONG)、hyp_099 (SOL ask優勢)
4. **4週間後再評価**: promote/demote判定 (min_activations=5, min_winrate=0.55)

---

## Coderタスク: 静観・フォールバック対策 - BTC/ETH戦略ゾーン方向修正

### タスクの背景

Reviewerレポート (state/review.json): performance_score=35
- 直近12サイクル中90%以上が「Rubber fallback: スパイクなし: 静観」
- [CRITICAL] フォールバック状態が壊滅的。代替戦略・早期復帰メカニズムの要求

---

### 根本原因の特定: 30日バックテスト分析 (5052本 BTC, 5051本 ETH)

#### BTC penetration ゾーンの方向誤り (重大問題)

| ゾーン | n | LONG_wr | SHORT_wr | avg_ret |
|--------|---|---------|---------|---------|
| penetration (-20~0%) | 22 | **55%** | 32% | **+0.230%** |
| upper_range (>20%) | 17 | 6% | **59%** | -0.321% |

- BTC penetration: BEAR spike後 **LONGが優位** (avg=+0.23%)
- 現行設定: penetration → SHORT → **逆方向で損失を出していた**
- TP0.3%/SL0.6%シミュレーション: W=14/L=3 → **PF=2.33**

#### ETH Pattern A (LONG reversal) のフィルター方向誤り (重大問題)

30日BT n=27 (threshold>=7.0x BEAR spike):

| 4H position | n | LONG_wr | avg_ret |
|------------|---|---------|---------|
| pos < 40% (低位) | 23 | **70%** | **+0.177%** |
| pos >= 40% (高位) | 4 | 25% | +0.180% |

- 現行フィルター: `h4_filter_pct=40` → `pos < 40% → SKIP, pos >= 40% → LONG`
- **フィルターが完全に逆方向！** WR=25%のゾーンでのみLONG許可していた
- 正しいフィルター: `pos >= 40% → SKIP, pos < 40% → LONG`

---

### 実施した変更

#### 1. `src/strategy/btc_rubber_wall.py`

| 項目 | 変更前 | 変更後 | 根拠 |
|------|--------|--------|------|
| penetration direction | short | **long** | 30日BT: LONG_wr=55%, PF=2.33 |
| penetration tp_pct | 0.5% | **0.3%** | TP縮小で実現可能性向上 |
| penetration sl_pct | (tp_pct*2=1.0%) | **0.6%** | R:R=2.0維持 |
| deep_reversal | long (0.3% TP) | **SKIP** | 30-40%勝率でエッジ不明確 |
| sl_pct フィールド追加 | なし | 追加 | ゾーンごとに個別SL設定可能に |

#### 2. `src/strategy/eth_rubber_band.py`

| 項目 | 変更前 | 変更後 | 根拠 |
|------|--------|--------|------|
| フィルター方向 | pos < filter → SKIP (下限) | pos >= max → SKIP **(上限)** | 30日BT: pos<40%でWR=70% |
| キー名 | reversal_h4_filter_pct=55 | **reversal_h4_max_pct=40** | フィルター方向の逆転・旧キー後方互換 |
| momentum_threshold | 4.0 (コードデフォルト) | **3.0** | 30日BT: mid+3.0xでSHORT_wr=88% |
| momentum_zone_min | 55 (コードデフォルト) | **40** | settings.yamlに合わせて整合 |

#### 3. `config/settings.yaml`

- `reversal_h4_filter_pct: 40` → `reversal_h4_max_pct: 40` に改名 (フィルター方向変更に対応)
- `momentum_threshold: 3.0` (維持)
- `momentum_zone_min: 40` (維持)

---

### 期待効果

| 指標 | 変更前 | 期待値 |
|------|--------|--------|
| BTC penetration SHORT | 旧WR=32% | LONG WR=55%, PF=2.33 |
| ETH Pattern A LONG | 旧WR=25% (誤フィルター) | **WR=70%** (正フィルター) |
| ETH Pattern A 機会 | pos>=40%のみ (n=4) | pos<40% (n=23, 6倍増) |
| 静観率 | 90%以上 | BTC機会1.1/d→2.3/d, ETH機会増加 |

### 構文チェック

- `src/strategy/btc_rubber_wall.py`: py_compile エラーなし ✓
- `src/strategy/eth_rubber_band.py`: py_compile エラーなし ✓
- 動作テスト: BTC/ETH strat.scan() 正常完了 ✓
