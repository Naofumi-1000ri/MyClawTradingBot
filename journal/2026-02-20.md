# myClaw Journal - 2026-02-20

## Coder Task: equity sanity check 追加 [2026-02-20]

- **問題**: `daily_pnl.equity` に間欠的な異常値（例: 4.10 USD, 20.39 USD）が発生。Agent Rのリスク判断を歪める。
- **変更ファイル**: `src/brain/brain_consensus.py`
- **対応内容**:
  - `_sanitize_equity_in_context()` 関数追加
  - equity < 50 USD または equity > 10,000 USD の場合、`daily_pnl.json`の保存値にフォールバック
  - 保存値も異常の場合は `start_of_day_equity` を使用
  - `main()` 内のコンテキスト構築直後 (step 1b) で呼び出し
- **即時修正**: `state/daily_pnl.json` の equity 20.39 USD → 508.29 USD に手動補正（計算式: start + realized + unrealized）
- **定数**: `_EQUITY_MIN_USD = 50.0`, `_EQUITY_MAX_USD = 10_000.0`

## Coder Task: signal_mergerに4Hトレンドフィルター追加 [2026-02-20]

- **問題**: フロー先行(F単独)でlongが部分合議を通過し、4H下降トレンド継続中に逆張りロングが連続発動していた。
- **変更ファイル**:
  - `src/brain/signal_merger.py` - フィルターロジック実装
  - `src/brain/brain_consensus.py` - market_dataをmerge_signalsに渡すよう修正
  - `src/collector/data_collector.py` - 4H取得本数 30→50本 (MACD計算要件)
  - `src/brain/build_context.py` - _CANDLE_LIMITS["candles_4h"] 15→50本
- **対応内容**:
  - `_calc_ema(values, period)`: EMA計算ユーティリティ
  - `_calc_macd_histogram(closes)`: MACD(12,26,9) histogram最新値計算
  - `_get_4h_trend_filter(market_data, symbol)`: 4H EMA9/EMA21とMACD_hist判定
  - 部分合議でF単独longかつ「4H EMA9<EMA21 **かつ** MACD_hist<0」の場合→ hold強制
  - 完全合議(T+F両方long)はフィルター対象外
  - データ不足(35本未満)時はフィルター非適用（安全側に倒す）
- **テスト結果**:
  - 30本(データ不足) → bearish=False、ブロックなし ✓
  - 50本下降トレンド + F単独long → hold (ブロック) ✓
  - 50本上昇トレンド + F単独long → long (通過) ✓
  - T+F完全合議 + 下降トレンド → long (通過) ✓

## Coder Task: 全エージェント失敗アラート機能追加 [2026-02-20]

- **変更ファイル**: `src/brain/brain_consensus.py`
- **内容**:
  - `_check_and_alert_all_agents_failed()` 関数追加: T/F/R全員が3サイクル連続失敗した場合を検出
  - `_append_agent_failure_journal()` 関数追加: journal/YYYY-MM-DD.md にCRITICALエントリ追記
  - `main()` 内でAgent R処理後にアラートチェックを呼び出す
  - `import re` を追加（元から使用されていたが未インポートだったバグも同時修正）
- **動作**: kill_switch.json の `warning=True` / `warning_reason` を設定 (`enabled` は変更しない)
- **閾値**: `_ALL_AGENTS_FAILED_THRESHOLD = 3`（3サイクル連続で全員失敗時）
