# myClaw Journal - 2026-02-20

## Coder Task: equity sanity check 追加 [2026-02-20]

- **問題**: `daily_pnl.equity` に間欠的な異常値（例: 4.10 USD, 20.39 USD）が発生。Agent Rのリスク判断を歪める。
- **変更ファイル**: `src/brain/brain_consensus.py`
- **対応内容**:
  - `_sanitize_equity_in_context()` 関数追加
  - equity < 50 USD または equity > 10,000 USD の場合、`daily_pnl.json`の保存値にフォールバック
  - 保存値も異常の場合は `start_of_day_equity` を使用
  - `main()` 内のコンテキスト構築直後 (step 1b) で呼び出し
- **即時修正**: `state/daily_pnl.json` の equity 20.39 USD → 508.29 USD に手動補正（計算式: start + realized + unrealized）
- **定数**: `_EQUITY_MIN_USD = 50.0`, `_EQUITY_MAX_USD = 10_000.0`

## Coder Task: signal_mergerに4Hトレンドフィルター追加 [2026-02-20]

- **問題**: フロー先行(F単独)でlongが部分合議を通過し、4H下降トレンド継続中に逆張りロングが連続発動していた。
- **変更ファイル**:
  - `src/brain/signal_merger.py` - フィルターロジック実装
  - `src/brain/brain_consensus.py` - market_dataをmerge_signalsに渡すよう修正
  - `src/collector/data_collector.py` - 4H取得本数 30→50本 (MACD計算要件)
  - `src/brain/build_context.py` - _CANDLE_LIMITS["candles_4h"] 15→50本
- **対応内容**:
  - `_calc_ema(values, period)`: EMA計算ユーティリティ
  - `_calc_macd_histogram(closes)`: MACD(12,26,9) histogram最新値計算
  - `_get_4h_trend_filter(market_data, symbol)`: 4H EMA9/EMA21とMACD_hist判定
  - 部分合議でF単独longかつ「4H EMA9<EMA21 **かつ** MACD_hist<0」の場合→ hold強制
  - 完全合議(T+F両方long)はフィルター対象外
  - データ不足(35本未満)時はフィルター非適用（安全側に倒す）
- **テスト結果**:
  - 30本(データ不足) → bearish=False、ブロックなし ✓
  - 50本下降トレンド + F単独long → hold (ブロック) ✓
  - 50本上昇トレンド + F単独long → long (通過) ✓
  - T+F完全合議 + 下降トレンド → long (通過) ✓

## Coder Task: ポジション最低保有時間ルール実装 [2026-02-20]

- **問題**: エントリー直後のclose繰り返しパターンが発生し、スプレッドコストが累積する。
- **変更ファイル**: `src/brain/signal_merger.py`
- **対応内容**:
  - `_MIN_HOLD_CYCLES = 2`（2サイクル = 10分）の最低保有時間定数を定義
  - `_R_CRITICAL_CLOSE_CONF = 0.90`：最低保有時間内でもcloseを許可するRの最低confidence閾値
  - `_get_position_opened_at(positions, symbol, trade_history)`: エントリー時刻取得（positions.json優先→trade_history.jsonフォールバック）
  - `_is_within_min_hold_period(opened_at)`: 最低保有時間内かどうかを判定
  - `merge_signals` に `trade_history` パラメータを追加（後方互換: デフォルトNone）
  - close判断ブロックに最低保有時間チェックを挿入：
    - positions.json の `opened_at` はAPIからsync時にNoneとなるため、trade_history.jsonの未クローズエントリーからフォールバック取得
    - 保有時間内かつRのcritical close未達 → hold変換（ログ出力あり）
    - 保有時間内かつR confidence >= 0.90 の close → 例外許可（緊急決済）
    - エントリー時刻不明（opened_at=None）→ チェックスキップ（安全側: closeを許可）
- **副作用なし**:
  - `trade_executor.py` は変更なし（禁止ファイル）
  - `merge_signals` のシグネチャ変更は後方互換（`trade_history=None` のデフォルト値）
  - 最低保有時間外のcloseは従来通り無条件許可

## Coder Task: ポジション最低保有時間ルール検証 [2026-02-20]

- **依頼内容**: `trade_executor.py` にポジション最低保有時間ルールを実装。
- **確認結果**: 上記タスク（同日）で既に `signal_merger.py` に完全実装済み。
  - `trade_executor.py` は変更禁止ファイルのため、close信号生成段階（signal_merger）でブロックする設計が適切。
  - 実行フロー上 `signal_merger.py` でブロックすれば `trade_executor.py` にclose信号が届かないため機能的に同等以上。
- **動作テスト結果**:
  - `_is_within_min_hold_period(5分後)` → True（保有時間内）✓
  - `_is_within_min_hold_period(12分後)` → False（保有時間外）✓
  - `_get_position_opened_at(positions)` → positions.json から取得 ✓
  - `_get_position_opened_at(notime_positions, history)` → trade_history フォールバック ✓
- **変更ファイル**: なし（実装済みのため）

## Coder Task: signal_merger.py 復元 [2026-02-20]

- **問題**: `git status` で `deleted: src/brain/signal_merger.py` と表示。コミット e45c9e2 で追加されたはずのファイルが作業ツリーから消えていた。
- **対応**: `git checkout HEAD -- src/brain/signal_merger.py` で復元。
- **確認**: 4Hトレンドフィルター（EMA9<EMA21かつMACD_hist<0 → F単独long hold強制）が正しく実装済みであることを確認。
- **構文チェック**: py_compile にてエラーなし。

## Coder Task: 全エージェント失敗アラート機能追加 [2026-02-20]

- **変更ファイル**: `src/brain/brain_consensus.py`, `src/monitor/monitor.py`
- **内容**:
  - `_track_agent_failure(failed: bool)` 関数追加: 連続失敗カウントを `state/agent_failure_count.json` で管理
  - `_trigger_agent_failure_alert(consecutive: int)` 関数追加:
    - `state/kill_switch.json` に `warning=True` / `warning_reason` / `warning_at` を設定
    - `journal/YYYY-MM-DD.md` に `CRITICAL: agent_failure` エントリを追記
    - Telegram通知送信
  - `_run_rubber_wall()` 末尾で全シンボル(BTC/ETH/SOL)がデータ不足の場合を失敗と判定して追跡
  - `src/monitor/monitor.py` の kill_switch チェックに `warning` フラグ検知を追加 (4a)
- **動作**: `kill_switch.enabled` は変更しない。`warning` フラグのみ設定（自動でalertを発報するが停止しない）
- **閾値**: `_AGENT_FAILURE_THRESHOLD = 3`（3サイクル連続で全シンボルデータ不足時）
- **失敗条件**: `btc_5m`・`eth_5m`・`sol_5m` の3つが全て空の場合（API障害・ネットワーク断等）

## Coder Task: 全エージェント失敗アラート機能強化 [2026-02-20]

- **問題**: 既存の `_track_agent_failure` はデータ不足（キャンドルデータ空）のみ追跡。
  コンテキスト構築失敗・ゴム戦略クラッシュ（例外終了）は失敗カウントされず、
  障害がサイレントフォールバックのまま放置されるリスクがあった。
- **変更ファイル**: `src/brain/brain_consensus.py`
- **対応内容**:
  - `main()` のコンテキスト構築失敗ブロック（`except Exception`）に `_track_agent_failure(failed=True)` を追加
  - `_run_rubber_wall()` の呼び出し部を `try/except` で囲み、クラッシュ時も `_track_agent_failure(failed=True)` を追加
  - `_trigger_agent_failure_alert()` のジャーナルメッセージを拡張（データ不足だけでなくコンテキスト失敗・クラッシュも明記）
- **失敗計上対象** (3種類すべてがカウント対象に):
  1. 全シンボルのキャンドルデータなし（既存）
  2. `build_context()` で例外発生（新規）
  3. `_run_rubber_wall()` で未捕捉例外が発生（新規）
- **閾値**: `_AGENT_FAILURE_THRESHOLD = 3`（変更なし）
- **アラート動作**: kill_switch.json に `warning=True` + journal CRITICAL記録 + Telegram通知（変更なし）

## Coder Task: エージェント障害時のリトライロジック実装 [2026-02-20]

- **目的**: エージェント障害発生時に一定回数リトライし、復旧しない場合はアラート発報 + 安全なホールド状態に移行する。
- **変更ファイル**:
  - `src/utils/retry.py` (新規作成)
  - `src/brain/brain_consensus.py` (main()関数修正)
  - `src/collector/data_collector.py` (collect()関数修正)

### src/utils/retry.py (新規)

リトライユーティリティモジュールを新規作成:

- `RetryExhausted`: リトライ上限に達した際の例外クラス
- `retry_with_backoff()`: デコレータ or 直接呼び出し対応の指数バックオフリトライ
- `call_with_retry()`: `fn` + `args/kwargs` で直接呼び出すインターフェース
- `enter_safe_hold()`: リトライ上限超過後の安全状態移行関数
  - `signals/signals.json` を `action_type: hold` で上書き
  - `state/kill_switch.json` に `warning=True` フラグ
  - Telegram アラート通知

### brain_consensus.py の変更

`main()` の各フェーズにリトライを追加:

- **コンテキスト構築** (`build_context()`): 最大2回リトライ (計3回試行, 3秒→6秒→12秒)
  - `RetryExhausted` 時: フォールバック出力 + `_track_agent_failure` + `enter_safe_hold`
- **ゴム戦略** (`_run_rubber_wall()`): 最大2回リトライ (計3回試行)
  - `RetryExhausted` 時: フォールバック出力 + `_track_agent_failure` + `enter_safe_hold`

### data_collector.py の変更

APIコールにリトライを追加:

- **Hyperliquid接続** (`_build_info()`): 最大2回リトライ。接続失敗で `enter_safe_hold` + `RuntimeError`
- **mid価格取得** (`_fetch_mid_prices()`): 最大2回リトライ。失敗時は空dict
- **資金調達率取得** (`_fetch_funding_rates()`): 最大2回リトライ。失敗時は空dict
- **キャンドルデータ取得** (`_fetch_candles()`): 各時間足・各シンボルで最大2回リトライ。失敗時は前回値フォールバック
- **オーダーブック取得** (`_fetch_orderbook()`): 最大2回リトライ。失敗時は前回値フォールバック

### リトライ設計方針

- `base_delay`: 2〜3秒 (APIネットワーク遅延を考慮)
- `backoff_factor`: 2.0 (指数バックオフ)
- `max_delay`: 10〜15秒 (5分サイクルの制約内)
- **重要なAPI接続失敗**: `enter_safe_hold` + 例外再送出 (サイクル中断)
- **データ取得失敗**: 前回値フォールバック (サイクル継続)
- **戦略実行失敗**: `enter_safe_hold` + フォールバックhold出力

## Coder Task: ETH Pattern A (reversal) エントリー精度向上 [2026-02-20]

### 根本原因分析

**直近SLヒット事例** (19:37-19:42 UTC):
- エントリー: ETH @ 1966.60 (vol_ratio=7.5x, Pattern A reversal)
- SL: 1964.63 (candle low 1966.50 - 0.05%pad)
- **SL距離: 0.10%** (最低保証ギリギリ) → 5分後即死
- 2回目シグナル (19:47): imbalance + cooldownブロックで救済も同じ問題

**構造的問題 3点**:
1. **SL最小距離0.1%が小さすぎ**: ETH 5分足ATRに対してバッファ不足でノイズに吹かれる
2. **4Hトレンドフィルターなし**: 4Hベアトレンド継続中でも逆張りLONGを発動
3. **reversal_threshold 6.0が低め**: vr=7.5-8.0でもリバーサル成立せず

### 実施した修正

**変更ファイル**: `src/strategy/eth_rubber_band.py`, `config/settings.yaml`

| パラメータ | 旧値 | 新値 | 理由 |
|-----------|------|------|------|
| `reversal_threshold` | 6.0 | **7.0** | より強い出来高スパイクのみ反転狙い |
| `reversal_tp_pct` | 0.4% | **0.5%** | SL拡大に合わせてR:R維持 |
| `reversal_sl_min_dist` | 0.1% | **0.25%** | ノイズ耐性確保（主修正） |
| `reversal_h4_filter_pct` | (なし) | **40%** | 4Hレンジ下位40%では抑制（新規追加） |

**SL算出ロジック変更**:
- 旧: `max(candle_low - 0.05%pad, entry * 0.999)` → 0.10%保証
- 新: `min(candle_low - 0.05%pad, entry * 0.9975)` → **0.25%保証** (低い方を採用)

**4Hトレンドフィルター追加**:
- `h4_pos = _range_position(candle.close, h4_low, h4_high)`
- `h4_pos < 40%` → Pattern A SKIP (ダウントレンド中の逆張り自動回避)
- 今回事例でも 4H pos=-19.7% (20:48 ログ) → フィルターで抑制可能だった

**R:R検証**:
- TP 0.5% / SL 0.25% = **R:R 2.0** (現実的で持続可能)
- 旧の見かけR:R 4.0は最小SL保証に依存しており実際はSLヒット頻発
- 60%勝率 × R:R 2.0 = 期待値 +0.20% (正の期待値維持)
