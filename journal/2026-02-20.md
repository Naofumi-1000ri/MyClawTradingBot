# myClaw Journal - 2026-02-20

## Coder Task: equity sanity check 追加 [2026-02-20]

- **問題**: `daily_pnl.equity` に間欠的な異常値（例: 4.10 USD, 20.39 USD）が発生。Agent Rのリスク判断を歪める。
- **変更ファイル**: `src/brain/brain_consensus.py`
- **対応内容**:
  - `_sanitize_equity_in_context()` 関数追加
  - equity < 50 USD または equity > 10,000 USD の場合、`daily_pnl.json`の保存値にフォールバック
  - 保存値も異常の場合は `start_of_day_equity` を使用
  - `main()` 内のコンテキスト構築直後 (step 1b) で呼び出し
- **即時修正**: `state/daily_pnl.json` の equity 20.39 USD → 508.29 USD に手動補正（計算式: start + realized + unrealized）
- **定数**: `_EQUITY_MIN_USD = 50.0`, `_EQUITY_MAX_USD = 10_000.0`

## Coder Task: 全エージェント失敗アラート機能追加 [2026-02-20]

- **変更ファイル**: `src/brain/brain_consensus.py`
- **内容**:
  - `_check_and_alert_all_agents_failed()` 関数追加: T/F/R全員が3サイクル連続失敗した場合を検出
  - `_append_agent_failure_journal()` 関数追加: journal/YYYY-MM-DD.md にCRITICALエントリ追記
  - `main()` 内でAgent R処理後にアラートチェックを呼び出す
  - `import re` を追加（元から使用されていたが未インポートだったバグも同時修正）
- **動作**: kill_switch.json の `warning=True` / `warning_reason` を設定 (`enabled` は変更しない)
- **閾値**: `_ALL_AGENTS_FAILED_THRESHOLD = 3`（3サイクル連続で全員失敗時）
